name: Code Quality Check

on:
  push:
    branches:
      - main
  pull_request: {}

concurrency:
  group: ${{ github.job }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  code-quality:
    name: ðŸ§ª Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v3

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: âŽ” Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'pnpm'

      - name: ðŸ“¥ Install Dependencies
        run: |
          echo "::group::ðŸ“¥ Installing Dependencies"
          # Check if package.json exists
          if [ ! -f "package.json" ]; then
            echo "Error: package.json not found"
            exit 1
          fi

          # Install dependencies with detailed error output
          pnpm install --frozen-lockfile --no-optional

          # Verify eslint is available
          if ! pnpm list eslint > /dev/null 2>&1; then
            echo "Warning: ESLint not found in dependencies"
            echo "Installing eslint as a development dependency"
            pnpm add -D eslint
          fi
          echo "::endgroup::"

      - name: ðŸ’… Run Prettier Check
        id: prettier
        continue-on-error: true
        run: |
          echo "::group::ðŸ’… Prettier Check"
          pnpm exec prettier --check "**/*.{ts,tsx,js,jsx,json,css,md}" || echo "Prettier check failed"
          echo "::endgroup::"

      - name: ðŸ”§ Run ESLint Fix
        id: lint-fix
        if: always()
        continue-on-error: true
        run: |
          echo "::group::ðŸ”§ ESLint Fix"
          pnpm exec eslint --fix "**/*.{ts,tsx,js,jsx}" || echo "ESLint fix failed"
          echo "::endgroup::"

      - name: ðŸ” Run TypeCheck
        id: typecheck
        if: always()
        continue-on-error: true
        run: |
          echo "::group::ðŸ” TypeScript Check"
          if [ -f "tsconfig.json" ]; then
            pnpm exec tsc --noEmit || echo "TypeScript check failed"
          else
            echo "No tsconfig.json found, skipping typecheck"
          fi
          echo "::endgroup::"

      - name: â¬£ Run ESLint Strict
        id: lint-strict
        if: always()
        continue-on-error: true
        run: |
          echo "::group::â¬£ ESLint Strict Check"
          pnpm exec eslint --max-warnings=0 --no-warn-ignored "**/*.{ts,tsx,js,jsx}" || echo "ESLint strict check failed"
          echo "::endgroup::"

      - name: ðŸ“‹ Check Results
        if: always()
        run: |
          echo "## ðŸ§ª Code Quality Results" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "| ----- | ------ |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.prettier.outcome }}" == "success" ]; then
            echo "| ðŸ’… Prettier | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ’… Prettier | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.lint-fix.outcome }}" == "success" ]; then
            echo "| ðŸ”§ ESLint Fix | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ”§ ESLint Fix | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.typecheck.outcome }}" == "success" ]; then
            echo "| ðŸ” TypeCheck | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ” TypeCheck | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.lint-strict.outcome }}" == "success" ]; then
            echo "| â¬£ ESLint Strict | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| â¬£ ESLint Strict | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ”„ Upload Changes (if any)
        if: ${{ github.event_name == 'pull_request' && (steps.lint-fix.outcome == 'success' || steps.prettier.outcome == 'success') }}
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: 'style: apply automatic formatting and linting fixes'
          commit_user_name: 'GitHub Actions'
          commit_user_email: 'actions@github.com'
          commit_author: 'GitHub Actions <actions@github.com>'
